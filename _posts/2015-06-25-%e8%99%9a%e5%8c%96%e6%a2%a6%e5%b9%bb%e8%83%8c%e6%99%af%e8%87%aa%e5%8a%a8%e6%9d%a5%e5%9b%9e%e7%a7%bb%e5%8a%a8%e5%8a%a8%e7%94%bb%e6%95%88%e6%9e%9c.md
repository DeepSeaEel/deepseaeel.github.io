---
layout:     post
title:      "虚化梦幻背景+自动来回移动动画效果"
subtitle:   "源码解析"
date: 2015-06-25T17:51:46+00:00
author:     "Roger"
header-img: "img/post-bg-2015.jpg"
tags:
    - Android UI
---
必须说写博客是一项非常需要毅力的事情，这两月稍微忙一点就完全忘了这茬了，罪过罪过。

今天解析一个 虚化梦幻背景+自动来回移动动画 的效果，这个动画也是从Muzei中提取出来了~感谢大神！！

首先上效果图：

<div style="width: 454px" class="wp-caption aligncenter">
  <a href="https://github.com/Rogero0o/MissView"><img src="http://ww3.sinaimg.cn/mw690/a695acdegw1es9pdp7jwug20cc0m5qvi.gif" alt="" width="444" height="794" /></a>
  
  <p class="wp-caption-text">
    MissView
  </p>
</div>

背景中的动态模糊和自动移动 就是效果啦..第一次看到是不是有点酷炫呢？ 让我弱弱的来分析一下源码。源码地址：<a href="https://github.com/Rogero0o/MissView" title="https://github.com/Rogero0o/MissView" target="_blank">https://github.com/Rogero0o/MissView<br /> </a>
  
包结构如下：
  
[<img class="alignnone size-medium wp-image-93" src="http://2.rogerbolg.sinaapp.com/wp-content/uploads/2015/06/package-189x300.jpg" alt="package" width="189" height="300" />](http://2.rogerbolg.sinaapp.com/wp-content/uploads/2015/06/package.jpg)

MissView.java 是主要的显示类
  
BlurRenderer.java 主要负责模糊像素处理
  
DemoRenderController.java 主要负责移动动画的处理

类不多而且一点都不复杂，若有心半小时内就能搞懂。

我们从MissView.java开始
  
<!--more-->

<div class="codecolorer-container java twitlight" style="overflow:auto;white-space:nowrap;width:100%;height:100%;">
  <div class="java codecolorer">
    <span class="kw1">public</span> <span class="kw1">class</span> MissView <span class="kw1">extends</span> GLTextureView <span class="kw1">implements</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; RenderController.<span class="me1">Callbacks</span>,<br /> &nbsp; &nbsp; &nbsp; &nbsp; BlurRenderer.<span class="me1">Callbacks</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; <span class="kw1">private</span> BlurRenderer mRenderer<span class="sy0">;</span><br /> &nbsp; &nbsp; <span class="kw1">private</span> RenderController mRenderController<span class="sy0">;</span><br /> <br /> &nbsp; &nbsp; <span class="kw1">public</span> MissView<span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&q=allinurl%3Acontext+java.sun.com&btnI=I%27m%20Feeling%20Lucky"><span class="kw3">Context</span></a> context<span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">super</span><span class="br0">&#40;</span>context<span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; init<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; <span class="br0">&#125;</span><br /> <br /> &nbsp; &nbsp; <span class="kw1">public</span> MissView<span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&q=allinurl%3Acontext+java.sun.com&btnI=I%27m%20Feeling%20Lucky"><span class="kw3">Context</span></a> context, <a href="http://www.google.com/search?hl=en&q=allinurl%3Aattributeset+java.sun.com&btnI=I%27m%20Feeling%20Lucky"><span class="kw3">AttributeSet</span></a> attrs<span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">super</span><span class="br0">&#40;</span>context, attrs<span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; init<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; <span class="br0">&#125;</span><br /> <br /> &nbsp; &nbsp; <span class="kw1">private</span> <span class="kw4">void</span> init<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; mRenderer <span class="sy0">=</span> <span class="kw1">new</span> BlurRenderer<span class="br0">&#40;</span>getContext<span class="br0">&#40;</span><span class="br0">&#41;</span>, <span class="kw1">this</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; setEGLContextClientVersion<span class="br0">&#40;</span><span class="nu0">2</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; setEGLConfigChooser<span class="br0">&#40;</span><span class="nu0">8</span>, <span class="nu0">8</span>, <span class="nu0">8</span>, <span class="nu0">8</span>, <span class="nu0"></span>, <span class="nu0"></span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; setRenderer<span class="br0">&#40;</span>mRenderer<span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; setRenderMode<span class="br0">&#40;</span>GLSurfaceView.<span class="me1">RENDERMODE_WHEN_DIRTY</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; <span class="br0">&#125;</span><br /> <br /> &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">void</span> initPicture<span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&q=allinurl%3Astring+java.sun.com&btnI=I%27m%20Feeling%20Lucky"><span class="kw3">String</span></a> mPictureName<span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; mRenderController <span class="sy0">=</span> <span class="kw1">new</span> DemoRenderController<span class="br0">&#40;</span>getContext<span class="br0">&#40;</span><span class="br0">&#41;</span>, mRenderer,<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">this</span>, <span class="kw2">true</span>, mPictureName<span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; mRenderer.<span class="me1">setDemoMode</span><span class="br0">&#40;</span><span class="kw2">true</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; mRenderController.<span class="me1">setVisible</span><span class="br0">&#40;</span><span class="kw2">true</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; <span class="br0">&#125;</span><br /> <br /> &nbsp; &nbsp; @Override<br /> &nbsp; &nbsp; <span class="kw1">protected</span> <span class="kw4">void</span> onSizeChanged<span class="br0">&#40;</span><span class="kw4">int</span> w, <span class="kw4">int</span> h, <span class="kw4">int</span> oldw, <span class="kw4">int</span> oldh<span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">super</span>.<span class="me1">onSizeChanged</span><span class="br0">&#40;</span>w, h, oldw, oldh<span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; mRenderer.<span class="me1">hintViewportSize</span><span class="br0">&#40;</span>w, h<span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; mRenderController.<span class="me1">reloadCurrentArtwork</span><span class="br0">&#40;</span><span class="kw2">true</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; <span class="br0">&#125;</span><br /> <br /> &nbsp; &nbsp; @Override<br /> &nbsp; &nbsp; <span class="kw1">protected</span> <span class="kw4">void</span> onDetachedFromWindow<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">super</span>.<span class="me1">onDetachedFromWindow</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw2">null</span> <span class="sy0">!=</span> mRenderController<span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mRenderController.<span class="me1">destroy</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; queueEventOnGlThread<span class="br0">&#40;</span><span class="kw1">new</span> <a href="http://www.google.com/search?hl=en&q=allinurl%3Arunnable+java.sun.com&btnI=I%27m%20Feeling%20Lucky"><span class="kw3">Runnable</span></a><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; @Override<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">void</span> run<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mRenderer.<span class="me1">destroy</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br /> &nbsp; &nbsp; <span class="br0">&#125;</span><br /> <br /> &nbsp; &nbsp; @Override<br /> &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">void</span> queueEventOnGlThread<span class="br0">&#40;</span><a href="http://www.google.com/search?hl=en&q=allinurl%3Arunnable+java.sun.com&btnI=I%27m%20Feeling%20Lucky"><span class="kw3">Runnable</span></a> runnable<span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw1">this</span> <span class="sy0">==</span> <span class="kw2">null</span><span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">super</span>.<span class="me1">queueEvent</span><span class="br0">&#40;</span>runnable<span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; <span class="br0">&#125;</span><br /> <br /> &nbsp; &nbsp; @Override<br /> &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">void</span> requestRender<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw1">this</span> <span class="sy0">==</span> <span class="kw2">null</span><span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">super</span>.<span class="me1">requestRender</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; <span class="br0">&#125;</span><br /> <br /> <span class="br0">&#125;</span>
  </div>
</div>

首先MissView继承的是GLTextureView,GLTextureView的详情可参考 <a title="http://stackoverflow.com/questions/12061419/converting-from-glsurfaceview-to-textureview-via-gltextureview" href="http://stackoverflow.com/questions/12061419/converting-from-glsurfaceview-to-textureview-via-gltextureview" target="_blank">http://stackoverflow.com/questions/12061419/converting-from-glsurfaceview-to-textureview-via-gltextureview<br /> </a>,总的来说就是4.0后一个可以显示OpenGL效果的View。关于OPENGL初级使用方法：<a href="http://android.tgbus.com/Android/tutorial/201103/343847.shtml" title="http://android.tgbus.com/Android/tutorial/201103/343847.shtml" target="_blank">http://android.tgbus.com/Android/tutorial/201103/343847.shtml</a>
  
初始化MissView后执行init方法：

<div class="codecolorer-container java twitlight" style="overflow:auto;white-space:nowrap;width:100%;">
  <div class="java codecolorer">
    mRenderer <span class="sy0">=</span> <span class="kw1">new</span> BlurRenderer<span class="br0">&#40;</span>getContext<span class="br0">&#40;</span><span class="br0">&#41;</span>, <span class="kw1">this</span><span class="br0">&#41;</span><span class="sy0">;</span><span class="co1">//初始化模糊控制器，使GLTextureView绘制图像。</span><br /> setEGLContextClientVersion<span class="br0">&#40;</span><span class="nu0">2</span><span class="br0">&#41;</span><span class="sy0">;</span><span class="co1">//设置OPENGL版本</span><br /> setEGLConfigChooser<span class="br0">&#40;</span><span class="nu0">8</span>, <span class="nu0">8</span>, <span class="nu0">8</span>, <span class="nu0">8</span>, <span class="nu0"></span>, <span class="nu0"></span><span class="br0">&#41;</span><span class="sy0">;</span><span class="co1">//设置OPENGL参数等</span><br /> setRenderer<span class="br0">&#40;</span>mRenderer<span class="br0">&#41;</span><span class="sy0">;</span><span class="co1">//设置Renderer</span><br /> setRenderMode<span class="br0">&#40;</span>GLSurfaceView.<span class="me1">RENDERMODE_WHEN_DIRTY</span><span class="br0">&#41;</span><span class="sy0">;</span><span class="co1">//设置模式</span>
  </div>
</div>

初始化完成后，需要调用 initPicture 初始化图片

<div class="codecolorer-container java twitlight" style="overflow:auto;white-space:nowrap;width:100%;">
  <div class="java codecolorer">
    mRenderController <span class="sy0">=</span> <span class="kw1">new</span> DemoRenderController<span class="br0">&#40;</span>getContext<span class="br0">&#40;</span><span class="br0">&#41;</span>, mRenderer,<br /> <span class="kw1">this</span>, <span class="kw2">true</span>, mPictureName<span class="br0">&#41;</span><span class="sy0">;</span><span class="co1">//初始化RenderController</span><br /> mRenderer.<span class="me1">setDemoMode</span><span class="br0">&#40;</span><span class="kw2">true</span><span class="br0">&#41;</span><span class="sy0">;</span><span class="co1">//设置Demo模式为true（带动画效果模式）</span><br /> mRenderController.<span class="me1">setVisible</span><span class="br0">&#40;</span><span class="kw2">true</span><span class="br0">&#41;</span><span class="sy0">;</span><span class="co1">//设置照片可见</span>
  </div>
</div>

这里提一下为什么要调用 mRenderController.setVisible(true);
  
跟进去，发现 setVisible 方法是这样写的：

<div class="codecolorer-container java twitlight" style="overflow:auto;white-space:nowrap;width:100%;">
  <div class="java codecolorer">
    <span class="kw1">public</span> <span class="kw4">void</span> setVisible<span class="br0">&#40;</span><span class="kw4">boolean</span> visible<span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; mVisible <span class="sy0">=</span> visible<span class="sy0">;</span><br /> &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>visible<span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; mCallbacks.<span class="me1">queueEventOnGlThread</span><span class="br0">&#40;</span><span class="kw1">new</span> <a href="http://www.google.com/search?hl=en&q=allinurl%3Arunnable+java.sun.com&btnI=I%27m%20Feeling%20Lucky"><span class="kw3">Runnable</span></a><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; @Override<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">void</span> run<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>mQueuedBitmapRegionLoader <span class="sy0">!=</span> <span class="kw2">null</span><span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mRenderer.<span class="me1">setAndConsumeBitmapRegionLoader</span><span class="br0">&#40;</span>mQueuedBitmapRegionLoader<span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mQueuedBitmapRegionLoader <span class="sy0">=</span> <span class="kw2">null</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; mCallbacks.<span class="me1">requestRender</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; <span class="br0">&#125;</span><br /> <span class="br0">&#125;</span>
  </div>
</div>

除了将View设置为可见外，在OPENGL线程中将 mQueuedBitmapRegionLoader 初始化好的图片设置进 View中，所以可以多次 initPicture 。

接下来一些回收内存的方法和操作，如onDetachedFromWindow ，在销毁View时将mRenderController和mRenderer回收。

接下来看看BlurRenderer中是怎么实现模糊的效果的，我们知道android4.4以后提供了模糊效果的方法，那在这里是如何实现模糊动画的呢？

在上面我们看到 setVisible 方法里有一个 mRenderer.setAndConsumeBitmapRegionLoader(mQueuedBitmapRegionLoader);
  
mRenderer其实就是BlurRenderer的一个实例。在方法 setAndConsumeBitmapRegionLoader 中看到这样一行：mNextGLPictureSet.load(bitmapRegionLoader);
  
继续跟进，看到内部类GLPictureSet，这是个重要的类

<div class="codecolorer-container java twitlight" style="overflow:auto;white-space:nowrap;width:100%;height:100%;">
  <div class="java codecolorer">
    <span class="kw1">private</span> <span class="kw1">class</span> GLPictureSet <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">private</span> <span class="kw4">int</span> mId<span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">private</span> <span class="kw1">volatile</span> <span class="kw4">float</span><span class="br0">&#91;</span><span class="br0">&#93;</span> mPMatrix <span class="sy0">=</span> <span class="kw1">new</span> <span class="kw4">float</span><span class="br0">&#91;</span><span class="nu0">16</span><span class="br0">&#93;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">private</span> <span class="kw1">final</span> <span class="kw4">float</span><span class="br0">&#91;</span><span class="br0">&#93;</span> mMVPMatrix <span class="sy0">=</span> <span class="kw1">new</span> <span class="kw4">float</span><span class="br0">&#91;</span><span class="nu0">16</span><span class="br0">&#93;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">private</span> GLPicture<span class="br0">&#91;</span><span class="br0">&#93;</span> mPictures <span class="sy0">=</span> <span class="kw1">new</span> GLPicture<span class="br0">&#91;</span>mBlurKeyframes <span class="sy0">+</span> <span class="nu0">1</span><span class="br0">&#93;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">private</span> <span class="kw4">boolean</span> mHasBitmap <span class="sy0">=</span> <span class="kw2">false</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">private</span> <span class="kw4">float</span> mBitmapAspectRatio <span class="sy0">=</span> 1f<span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">private</span> <span class="kw4">int</span> mDimAmount <span class="sy0">=</span> <span class="nu0"></span><span class="sy0">;</span><br /> <br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> GLPictureSet<span class="br0">&#40;</span><span class="kw4">int</span> id<span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mId <span class="sy0">=</span> id<span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br /> <br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">void</span> load<span class="br0">&#40;</span>BitmapRegionLoader bitmapRegionLoader<span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mHasBitmap <span class="sy0">=</span> <span class="br0">&#40;</span>bitmapRegionLoader <span class="sy0">!=</span> <span class="kw2">null</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mBitmapAspectRatio <span class="sy0">=</span> mHasBitmap<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">?</span> bitmapRegionLoader.<span class="me1">getWidth</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">*</span> 1f <span class="sy0">/</span> bitmapRegionLoader.<span class="me1">getHeight</span><span class="br0">&#40;</span><span class="br0">&#41;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">:</span> 1f<span class="sy0">;</span><br /> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mDimAmount <span class="sy0">=</span> DEFAULT_MAX_DIM<span class="sy0">;</span><br /> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; destroyPictures<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>bitmapRegionLoader <span class="sy0">!=</span> <span class="kw2">null</span><span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BitmapFactory.<span class="me1">Options</span> options <span class="sy0">=</span> <span class="kw1">new</span> BitmapFactory.<span class="me1">Options</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Rect rect <span class="sy0">=</span> <span class="kw1">new</span> Rect<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">int</span> originalWidth <span class="sy0">=</span> bitmapRegionLoader.<span class="me1">getWidth</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">int</span> originalHeight <span class="sy0">=</span> bitmapRegionLoader.<span class="me1">getHeight</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Calculate image darkness to determine dim amount</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rect.<span class="me1">set</span><span class="br0">&#40;</span><span class="nu0"></span>, <span class="nu0"></span>, originalWidth, originalHeight<span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; options.<span class="me1">inSampleSize</span> <span class="sy0">=</span> ImageUtil.<span class="me1">calculateSampleSize</span><span class="br0">&#40;</span>originalHeight, <span class="nu0">64</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Bitmap tempBitmap <span class="sy0">=</span> bitmapRegionLoader.<span class="me1">decodeRegion</span><span class="br0">&#40;</span>rect, options<span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">float</span> darkness <span class="sy0">=</span> ImageUtil.<span class="me1">calculateDarkness</span><span class="br0">&#40;</span>tempBitmap<span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mDimAmount <span class="sy0">=</span> mDemoMode<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">?</span> DEMO_DIM<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">:</span> <span class="br0">&#40;</span><span class="kw4">int</span><span class="br0">&#41;</span> <span class="br0">&#40;</span>mMaxDim <span class="sy0">*</span> <span class="br0">&#40;</span><span class="br0">&#40;</span><span class="nu0">1</span> <span class="sy0">-</span> DIM_RANGE<span class="br0">&#41;</span> <span class="sy0">+</span> DIM_RANGE <span class="sy0">*</span> <a href="http://www.google.com/search?hl=en&q=allinurl%3Amath+java.sun.com&btnI=I%27m%20Feeling%20Lucky"><span class="kw3">Math</span></a>.<span class="me1">sqrt</span><span class="br0">&#40;</span>darkness<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tempBitmap.<span class="me1">recycle</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Create the GLPicture objects</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mPictures<span class="br0">&#91;</span><span class="nu0"></span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="kw1">new</span> GLPicture<span class="br0">&#40;</span>bitmapRegionLoader, mHeight<span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>mMaxPrescaledBlurPixels <span class="sy0">==</span> <span class="nu0"></span><span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">int</span> f <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">;</span> f <span class="sy0"><=</span> mBlurKeyframes<span class="sy0">;</span> f<span class="sy0">++</span><span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mPictures<span class="br0">&#91;</span>f<span class="br0">&#93;</span> <span class="sy0">=</span> mPictures<span class="br0">&#91;</span><span class="nu0"></span><span class="br0">&#93;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ImageBlurrer blurrer <span class="sy0">=</span> <span class="kw1">new</span> ImageBlurrer<span class="br0">&#40;</span>mContext<span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// To blur, first load the entire bitmap region, but at a very large</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// sample size that's appropriate for the final blurred image</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; options.<span class="me1">inSampleSize</span> <span class="sy0">=</span> ImageUtil.<span class="me1">calculateSampleSize</span><span class="br0">&#40;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; originalHeight, mHeight <span class="sy0">/</span> mBlurredSampleSize<span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rect.<span class="me1">set</span><span class="br0">&#40;</span><span class="nu0"></span>, <span class="nu0"></span>, originalWidth, originalHeight<span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tempBitmap <span class="sy0">=</span> bitmapRegionLoader.<span class="me1">decodeRegion</span><span class="br0">&#40;</span>rect, options<span class="br0">&#41;</span><span class="sy0">;</span><br /> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Next, create a scaled down version of the bitmap so that the blur radius</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// looks appropriate (tempBitmap will likely be bigger than the final blurred</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// bitmap, and thus the blur may look smaller if we just used tempBitmap as</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// the final blurred bitmap).</span><br /> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Note that image width should be a multiple of 4 to avoid</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// issues with RenderScript allocations.</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">int</span> scaledHeight <span class="sy0">=</span> <a href="http://www.google.com/search?hl=en&q=allinurl%3Amath+java.sun.com&btnI=I%27m%20Feeling%20Lucky"><span class="kw3">Math</span></a>.<span class="me1">max</span><span class="br0">&#40;</span><span class="nu0">2</span>, MathUtil.<span class="me1">floorEven</span><span class="br0">&#40;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mHeight <span class="sy0">/</span> mBlurredSampleSize<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">int</span> scaledWidth <span class="sy0">=</span> <a href="http://www.google.com/search?hl=en&q=allinurl%3Amath+java.sun.com&btnI=I%27m%20Feeling%20Lucky"><span class="kw3">Math</span></a>.<span class="me1">max</span><span class="br0">&#40;</span><span class="nu0">4</span>, MathUtil.<span class="me1">roundMult4</span><span class="br0">&#40;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#40;</span><span class="kw4">int</span><span class="br0">&#41;</span> <span class="br0">&#40;</span>scaledHeight <span class="sy0">*</span> mBitmapAspectRatio<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Bitmap scaledBitmap <span class="sy0">=</span> Bitmap.<span class="me1">createScaledBitmap</span><span class="br0">&#40;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tempBitmap, scaledWidth, scaledHeight, <span class="kw2">true</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tempBitmap.<span class="me1">recycle</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// And finally, create a blurred copy for each keyframe.</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">int</span> f <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">;</span> f <span class="sy0"><=</span> mBlurKeyframes<span class="sy0">;</span> f<span class="sy0">++</span><span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">float</span> desaturateAmount <span class="sy0">=</span> mMaxGrey <span class="sy0">/</span> 500f <span class="sy0">*</span> f <span class="sy0">/</span> mBlurKeyframes<span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Bitmap blurredBitmap <span class="sy0">=</span> blurrer.<span class="me1">blurBitmap</span><span class="br0">&#40;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; scaledBitmap, blurRadiusAtFrame<span class="br0">&#40;</span>f<span class="br0">&#41;</span>, desaturateAmount<span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mPictures<span class="br0">&#91;</span>f<span class="br0">&#93;</span> <span class="sy0">=</span> <span class="kw1">new</span> GLPicture<span class="br0">&#40;</span>blurredBitmap<span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; blurredBitmap.<span class="me1">recycle</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br /> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; scaledBitmap.<span class="me1">recycle</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; blurrer.<span class="me1">destroy</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br /> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; recomputeTransformMatrices<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mCallbacks.<span class="me1">requestRender</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br /> <br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">private</span> <span class="kw4">void</span> recomputeTransformMatrices<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">float</span> screenToBitmapAspectRatio <span class="sy0">=</span> mAspectRatio <span class="sy0">/</span> mBitmapAspectRatio<span class="sy0">;</span><br /> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Ensure the bitmap is wider than the screen relatively by applying zoom</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// if necessary. Vary width but keep height the same.</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">float</span> zoom <span class="sy0">=</span> <a href="http://www.google.com/search?hl=en&q=allinurl%3Amath+java.sun.com&btnI=I%27m%20Feeling%20Lucky"><span class="kw3">Math</span></a>.<span class="me1">max</span><span class="br0">&#40;</span>1f, 1.15f <span class="sy0">*</span> screenToBitmapAspectRatio<span class="br0">&#41;</span><span class="sy0">;</span><br /> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Total scale factors in both zoom and scale due to aspect ratio.</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">float</span> totalScale <span class="sy0">=</span> zoom <span class="sy0">/</span> screenToBitmapAspectRatio<span class="sy0">;</span><br /> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mCurrentViewport.<span class="me1">left</span> <span class="sy0">=</span> MathUtil.<span class="me1">interpolate</span><span class="br0">&#40;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">-</span>1f <span class="sy0">*</span> <a href="http://www.google.com/search?hl=en&q=allinurl%3Amath+java.sun.com&btnI=I%27m%20Feeling%20Lucky"><span class="kw3">Math</span></a>.<span class="me1">min</span><span class="br0">&#40;</span>1f, screenToBitmapAspectRatio<span class="br0">&#41;</span>, <span class="co1">// remove screenToBitmapAspectRatio to unconstrain panning amount</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1f <span class="sy0">*</span> <a href="http://www.google.com/search?hl=en&q=allinurl%3Amath+java.sun.com&btnI=I%27m%20Feeling%20Lucky"><span class="kw3">Math</span></a>.<span class="me1">min</span><span class="br0">&#40;</span>1f, screenToBitmapAspectRatio<span class="br0">&#41;</span>,<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mNormalOffsetX <span class="sy0">*</span> <span class="br0">&#40;</span>totalScale <span class="sy0">-</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="sy0">/</span> totalScale<span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mCurrentViewport.<span class="me1">right</span> <span class="sy0">=</span> mCurrentViewport.<span class="me1">left</span> <span class="sy0">+</span> 2f <span class="sy0">/</span> totalScale<span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mCurrentViewport.<span class="me1">bottom</span> <span class="sy0">=</span> <span class="sy0">-</span>1f <span class="sy0">/</span> zoom<span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mCurrentViewport.<span class="me1">top</span> <span class="sy0">=</span> 1f <span class="sy0">/</span> zoom<span class="sy0">;</span><br /> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">float</span> focusAmount <span class="sy0">=</span> <span class="br0">&#40;</span>mBlurKeyframes <span class="sy0">-</span> mBlurAnimator.<span class="me1">currentValue</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="sy0">/</span> mBlurKeyframes<span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>mBlurRelatedToArtDetailMode <span class="sy0">&&</span> focusAmount <span class="sy0">></span> <span class="nu0"></span><span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RectF artDetailViewport <span class="sy0">=</span> ArtDetailViewport.<span class="me1">getInstance</span><span class="br0">&#40;</span><span class="br0">&#41;</span>.<span class="me1">getViewport</span><span class="br0">&#40;</span>mId<span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>artDetailViewport.<span class="me1">width</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">==</span> <span class="nu0"></span> <span class="sy0">||</span> artDetailViewport.<span class="me1">height</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">==</span> <span class="nu0"></span><span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span>mDemoMode <span class="sy0">&&</span> <span class="sy0">!</span>mPreview<span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// reset art detail viewport</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ArtDetailViewport.<span class="me1">getInstance</span><span class="br0">&#40;</span><span class="br0">&#41;</span>.<span class="me1">setViewport</span><span class="br0">&#40;</span>mId,<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MathUtil.<span class="me1">uninterpolate</span><span class="br0">&#40;</span><span class="sy0">-</span><span class="nu0">1</span>, <span class="nu0">1</span>, mCurrentViewport.<span class="me1">left</span><span class="br0">&#41;</span>,<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MathUtil.<span class="me1">uninterpolate</span><span class="br0">&#40;</span><span class="nu0">1</span>, <span class="sy0">-</span><span class="nu0">1</span>, mCurrentViewport.<span class="me1">top</span><span class="br0">&#41;</span>,<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MathUtil.<span class="me1">uninterpolate</span><span class="br0">&#40;</span><span class="sy0">-</span><span class="nu0">1</span>, <span class="nu0">1</span>, mCurrentViewport.<span class="me1">right</span><span class="br0">&#41;</span>,<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MathUtil.<span class="me1">uninterpolate</span><span class="br0">&#40;</span><span class="nu0">1</span>, <span class="sy0">-</span><span class="nu0">1</span>, mCurrentViewport.<span class="me1">bottom</span><span class="br0">&#41;</span>,<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw2">false</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// interpolate</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mCurrentViewport.<span class="me1">left</span> <span class="sy0">=</span> MathUtil.<span class="me1">interpolate</span><span class="br0">&#40;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mCurrentViewport.<span class="me1">left</span>,<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MathUtil.<span class="me1">interpolate</span><span class="br0">&#40;</span><span class="sy0">-</span><span class="nu0">1</span>, <span class="nu0">1</span>, artDetailViewport.<span class="me1">left</span><span class="br0">&#41;</span>,<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; focusAmount<span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mCurrentViewport.<span class="me1">top</span> <span class="sy0">=</span> MathUtil.<span class="me1">interpolate</span><span class="br0">&#40;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mCurrentViewport.<span class="me1">top</span>,<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MathUtil.<span class="me1">interpolate</span><span class="br0">&#40;</span><span class="nu0">1</span>, <span class="sy0">-</span><span class="nu0">1</span>, artDetailViewport.<span class="me1">top</span><span class="br0">&#41;</span>,<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; focusAmount<span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mCurrentViewport.<span class="me1">right</span> <span class="sy0">=</span> MathUtil.<span class="me1">interpolate</span><span class="br0">&#40;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mCurrentViewport.<span class="me1">right</span>,<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MathUtil.<span class="me1">interpolate</span><span class="br0">&#40;</span><span class="sy0">-</span><span class="nu0">1</span>, <span class="nu0">1</span>, artDetailViewport.<span class="me1">right</span><span class="br0">&#41;</span>,<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; focusAmount<span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mCurrentViewport.<span class="me1">bottom</span> <span class="sy0">=</span> MathUtil.<span class="me1">interpolate</span><span class="br0">&#40;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mCurrentViewport.<span class="me1">bottom</span>,<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MathUtil.<span class="me1">interpolate</span><span class="br0">&#40;</span><span class="nu0">1</span>, <span class="sy0">-</span><span class="nu0">1</span>, artDetailViewport.<span class="me1">bottom</span><span class="br0">&#41;</span>,<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; focusAmount<span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br /> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Matrix.<span class="me1">orthoM</span><span class="br0">&#40;</span>mPMatrix, <span class="nu0"></span>,<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mCurrentViewport.<span class="me1">left</span>, mCurrentViewport.<span class="me1">right</span>,<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mCurrentViewport.<span class="me1">bottom</span>, mCurrentViewport.<span class="me1">top</span>,<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="nu0">1</span>, <span class="nu0">10</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br /> <br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">void</span> drawFrame<span class="br0">&#40;</span><span class="kw4">float</span> globalAlpha<span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span>mHasBitmap<span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br /> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Matrix.<span class="me1">multiplyMM</span><span class="br0">&#40;</span>mMVPMatrix, <span class="nu0"></span>, mVMatrix, <span class="nu0"></span>, mMMatrix, <span class="nu0"></span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Matrix.<span class="me1">multiplyMM</span><span class="br0">&#40;</span>mMVPMatrix, <span class="nu0"></span>, mPMatrix, <span class="nu0"></span>, mMVPMatrix, <span class="nu0"></span><span class="br0">&#41;</span><span class="sy0">;</span><br /> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">float</span> blurFrame <span class="sy0">=</span> mBlurAnimator.<span class="me1">currentValue</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">int</span> lo <span class="sy0">=</span> <span class="br0">&#40;</span><span class="kw4">int</span><span class="br0">&#41;</span> <a href="http://www.google.com/search?hl=en&q=allinurl%3Amath+java.sun.com&btnI=I%27m%20Feeling%20Lucky"><span class="kw3">Math</span></a>.<span class="me1">floor</span><span class="br0">&#40;</span>blurFrame<span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">int</span> hi <span class="sy0">=</span> <span class="br0">&#40;</span><span class="kw4">int</span><span class="br0">&#41;</span> <a href="http://www.google.com/search?hl=en&q=allinurl%3Amath+java.sun.com&btnI=I%27m%20Feeling%20Lucky"><span class="kw3">Math</span></a>.<span class="me1">ceil</span><span class="br0">&#40;</span>blurFrame<span class="br0">&#41;</span><span class="sy0">;</span><br /> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">float</span> localHiAlpha <span class="sy0">=</span> <span class="br0">&#40;</span>blurFrame <span class="sy0">-</span> lo<span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>globalAlpha <span class="sy0"><=</span> <span class="nu0"></span><span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Nothing to draw</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="kw1">if</span> <span class="br0">&#40;</span>lo <span class="sy0">==</span> hi<span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Just draw one</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mPictures<span class="br0">&#91;</span>lo<span class="br0">&#93;</span>.<span class="me1">draw</span><span class="br0">&#40;</span>mMVPMatrix, globalAlpha<span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="kw1">if</span> <span class="br0">&#40;</span>globalAlpha <span class="sy0">==</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Simple drawing</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mPictures<span class="br0">&#91;</span>lo<span class="br0">&#93;</span>.<span class="me1">draw</span><span class="br0">&#40;</span>mMVPMatrix, <span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mPictures<span class="br0">&#91;</span>hi<span class="br0">&#93;</span>.<span class="me1">draw</span><span class="br0">&#40;</span>mMVPMatrix, localHiAlpha<span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// If there's both a global and local alpha, re-compose alphas, to</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// effectively compose hi and lo before composing the result</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// with the background.</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// The math, where a1,a2 are previous alphas and b1,b2 are new alphas:</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// &nbsp; b1 = a1 * (a2 - 1) / (a1 * a2 - 1)</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// &nbsp; b2 = a1 * a2</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">float</span> newLocalLoAlpha <span class="sy0">=</span> globalAlpha <span class="sy0">*</span> <span class="br0">&#40;</span>localHiAlpha <span class="sy0">-</span> <span class="nu0">1</span><span class="br0">&#41;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">/</span> <span class="br0">&#40;</span>globalAlpha <span class="sy0">*</span> localHiAlpha <span class="sy0">-</span> <span class="nu0">1</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">float</span> newLocalHiAlpha <span class="sy0">=</span> globalAlpha <span class="sy0">*</span> localHiAlpha<span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mPictures<span class="br0">&#91;</span>lo<span class="br0">&#93;</span>.<span class="me1">draw</span><span class="br0">&#40;</span>mMVPMatrix, newLocalLoAlpha<span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mPictures<span class="br0">&#91;</span>hi<span class="br0">&#93;</span>.<span class="me1">draw</span><span class="br0">&#40;</span>mMVPMatrix, newLocalHiAlpha<span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br /> <br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">void</span> destroyPictures<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">int</span> i <span class="sy0">=</span> <span class="nu0"></span><span class="sy0">;</span> i <span class="sy0"><</span> mPictures.<span class="me1">length</span><span class="sy0">;</span> i<span class="sy0">++</span><span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>mPictures<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy0">==</span> <span class="kw2">null</span><span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">continue</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br /> <br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mPictures<span class="br0">&#91;</span>i<span class="br0">&#93;</span>.<span class="me1">destroy</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mPictures<span class="br0">&#91;</span>i<span class="br0">&#93;</span> <span class="sy0">=</span> <span class="kw2">null</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br /> &nbsp; &nbsp; <span class="br0">&#125;</span><br /> <br /> &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">void</span> destroy<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; mCurrentGLPictureSet.<span class="me1">destroyPictures</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; mNextGLPictureSet.<span class="me1">destroyPictures</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; <span class="br0">&#125;</span><br /> <br /> &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">boolean</span> isBlurred<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> mIsBlurred<span class="sy0">;</span><br /> &nbsp; &nbsp; <span class="br0">&#125;</span><br /> <br /> &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">void</span> setIsBlurred<span class="br0">&#40;</span><span class="kw1">final</span> <span class="kw4">boolean</span> isBlurred, <span class="kw1">final</span> <span class="kw4">boolean</span> artDetailMode<span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>artDetailMode <span class="sy0">&&</span> <span class="sy0">!</span>isBlurred <span class="sy0">&&</span> <span class="sy0">!</span>mDemoMode <span class="sy0">&&</span> <span class="sy0">!</span>mPreview<span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Reset art detail viewport</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ArtDetailViewport.<span class="me1">getInstance</span><span class="br0">&#40;</span><span class="br0">&#41;</span>.<span class="me1">setViewport</span><span class="br0">&#40;</span><span class="nu0"></span>, <span class="nu0"></span>, <span class="nu0"></span>, <span class="nu0"></span>, <span class="nu0"></span>, <span class="kw2">false</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ArtDetailViewport.<span class="me1">getInstance</span><span class="br0">&#40;</span><span class="br0">&#41;</span>.<span class="me1">setViewport</span><span class="br0">&#40;</span><span class="nu0">1</span>, <span class="nu0"></span>, <span class="nu0"></span>, <span class="nu0"></span>, <span class="nu0"></span>, <span class="kw2">false</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br /> <br /> &nbsp; &nbsp; &nbsp; &nbsp; mBlurRelatedToArtDetailMode <span class="sy0">=</span> artDetailMode<span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; mIsBlurred <span class="sy0">=</span> isBlurred<span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; mBlurAnimator.<span class="me1">cancel</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; mBlurAnimator<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .<span class="me1">to</span><span class="br0">&#40;</span>isBlurred <span class="sy0">?</span> mBlurKeyframes <span class="sy0">:</span> <span class="nu0"></span><span class="br0">&#41;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .<span class="me1">withDuration</span><span class="br0">&#40;</span>BLUR_ANIMATION_DURATION <span class="sy0">*</span> <span class="br0">&#40;</span>mDemoMode <span class="sy0">?</span> <span class="nu0">5</span> <span class="sy0">:</span> <span class="nu0">1</span><span class="br0">&#41;</span><span class="br0">&#41;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .<span class="me1">withEndListener</span><span class="br0">&#40;</span><span class="kw1">new</span> <a href="http://www.google.com/search?hl=en&q=allinurl%3Arunnable+java.sun.com&btnI=I%27m%20Feeling%20Lucky"><span class="kw3">Runnable</span></a><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; @Override<br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">void</span> run<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>isBlurred <span class="sy0">&&</span> artDetailMode<span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <a href="http://www.google.com/search?hl=en&q=allinurl%3Asystem+java.sun.com&btnI=I%27m%20Feeling%20Lucky"><span class="kw3">System</span></a>.<span class="me1">gc</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><span class="br0">&#41;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .<span class="me1">start</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; mCallbacks.<span class="me1">requestRender</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; <span class="br0">&#125;</span><br /> <br /> &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw1">static</span> <span class="kw1">interface</span> Callbacks <span class="br0">&#123;</span><br /> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">void</span> requestRender<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; <span class="br0">&#125;</span>
  </div>
</div>

首先看到load方法，在一些读取文件和设置属性的操作后我们看到 ImageBlurrer，嘿嘿，主角终于出现了。
  
往后看，重点来了：

<div class="codecolorer-container java twitlight" style="overflow:auto;white-space:nowrap;width:100%;">
  <div class="java codecolorer">
    <span class="co1">// And finally, create a blurred copy for each keyframe.</span><br /> <span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw4">int</span> f <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">;</span> f <span class="sy0"><=</span> mBlurKeyframes<span class="sy0">;</span> f<span class="sy0">++</span><span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; <span class="kw4">float</span> desaturateAmount <span class="sy0">=</span> mMaxGrey <span class="sy0">/</span> 500f <span class="sy0">*</span> f <span class="sy0">/</span> mBlurKeyframes<span class="sy0">;</span><br /> &nbsp; &nbsp; Bitmap blurredBitmap <span class="sy0">=</span> blurrer.<span class="me1">blurBitmap</span><span class="br0">&#40;</span><br /> &nbsp; &nbsp; scaledBitmap, blurRadiusAtFrame<span class="br0">&#40;</span>f<span class="br0">&#41;</span>, desaturateAmount<span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; mPictures<span class="br0">&#91;</span>f<span class="br0">&#93;</span> <span class="sy0">=</span> <span class="kw1">new</span> GLPicture<span class="br0">&#40;</span>blurredBitmap<span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; blurredBitmap.<span class="me1">recycle</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> <span class="br0">&#125;</span>
  </div>
</div>

And finally, create a blurred copy for each keyframe. 最终，把每一帧的模糊图像拷贝到数组mPictures中！大功告成！！在 drawFrame 方法中，你会看到如何将数组中的图像展示的，就不再赘述了。

那么剩下的横向来回移动呢？
  
请看到 DemoRenderController 类的 runAnimation 方法：

<div class="codecolorer-container java twitlight" style="overflow:auto;white-space:nowrap;width:100%;">
  <div class="java codecolorer">
    mCurrentScrollAnimator <span class="sy0">=</span> ObjectAnimator.<span class="me1">ofFloat</span><span class="br0">&#40;</span>mRenderer, <span class="st0">"normalOffsetX"</span>,mReverseDirection <span class="sy0">?</span> 1f <span class="sy0">:</span> 0f, mReverseDirection <span class="sy0">?</span> 0f <span class="sy0">:</span> 1f<span class="br0">&#41;</span>.<span class="me1">setDuration</span><span class="br0">&#40;</span>ANIMATION_CYCLE_TIME_MILLIS<span class="br0">&#41;</span><span class="sy0">;</span><br /> mCurrentScrollAnimator.<span class="me1">start</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> mCurrentScrollAnimator.<span class="me1">addListener</span><span class="br0">&#40;</span><span class="kw1">new</span> AnimatorListenerAdapter<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; @Override<br /> &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">void</span> onAnimationEnd<span class="br0">&#40;</span>Animator animation<span class="br0">&#41;</span> <span class="br0">&#123;</span><br /> &nbsp; &nbsp; <span class="kw1">super</span>.<span class="me1">onAnimationEnd</span><span class="br0">&#40;</span>animation<span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; mReverseDirection <span class="sy0">=</span> <span class="sy0">!</span>mReverseDirection<span class="sy0">;</span><br /> &nbsp; &nbsp; runAnimation<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span><br /> &nbsp; &nbsp; <span class="br0">&#125;</span><br /> <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
  </div>
</div>

是不是比想象中的简单？一个移动动画再加一个监听就完成了~~..

至此功能解析基本结束，其实这个效果的实现最关键的是要掌握OPENGL的使用和动画的优化工作！再次感谢大神！！

欢迎任何问题和拍砖提问 ：）